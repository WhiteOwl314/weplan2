<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
      PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="mapper.goal">
	<resultMap type="goalVO" id="goalVOResult">
		<!-- property: dto / column: db필드명  -->
		<result property="id" column="ID" />
        <result property="title" column="title" />
        <result property="content" column="content" />
        <result property="isCompleted" column="isCompleted" />
        <result property="importance" column="importance" />
        <result property="limitDate" column="limitdate" />
        <result property="startDate" column="startdate" />
	</resultMap>
	<resultMap type="yearlyPlanVO" id="yearlyPlanVOResult">
		<!-- property: dto / column: db필드명  -->
		<result property="id" column="ID" />
        <result property="title" column="title" />
        <result property="content" column="content" />
        <result property="importance" column="importance" />
        <result property="startDate" column="startdate" />
        <result property="limitDate" column="limitdate" />
        <result property="isCompleted" column="isCompleted" />
	</resultMap>
	
	<select 
		id="goalList" 
		resultMap="goalVOResult" 
		parameterType="String"
	>
      <![CDATA[
		SELECT 
			ID,
			title,
			content,
			isCompleted,
			importance,
			TO_CHAR(limitdate, 'YYYY-MM-DD') AS limitdate
		FROM W_GOAL 
		WHERE 
			isdelete = '0' 
			AND isCompleted = '0' 
			AND member_id = #{member_id}
		ORDER BY credate ASC
      ]]>
	</select>
	
	 <select id="selectNewGoal_NO" resultType="int"  >
		<![CDATA[
			SELECT  nvl(max(ID), 0) + 1 from W_GOAL	
		]]>
	</select> 
	
	<insert 
		id="addGoal" 
		parameterType="goalVO" 
	>
      <![CDATA[
      	INSERT INTO W_GOAL(
      		member_id,
      		id,
      		title,
      		content,
      		importance,
      		startDate,
      		limitDate
      	)
      	VALUES (
      		#{member_id},
      		#{id},
      		#{title},
      		#{content},
      		#{importance},
      		TO_DATE(#{startDate},'yyyy-mm-dd'),
      		TO_DATE(#{limitDate},'yyyy-mm-dd')
      	)
      ]]>
	</insert>
	
	<select 
  		id="popUpGoalView" 
  		resultMap="goalVOResult"   
  		parameterType="int"
  	>
      <![CDATA[
		SELECT 
			ID,
			title,
			content,
			isCompleted,
			importance,
			TO_CHAR(limitdate, 'YYYY-MM-DD') AS limitdate,
			TO_CHAR(startdate, 'YYYY-MM-DD') AS startdate
		FROM W_GOAL 
		WHERE 
			isdelete = '0' 
			AND isCompleted = '0' 
			AND ID = #{goal_id}
		ORDER BY credate DESC
      ]]>
	</select>
	
	
	<update 
		id="updateGoal"
		parameterType="goalVO"
	>
	  	UPDATE W_GOAL
	  	SET 
	  		importance = #{importance},
	  		title = #{title},
	  		content = #{content},
	  		limitDate = TO_DATE(#{limitDate},'yyyy-mm-dd')
	  	WHERE 
	  		isdelete = '0'  
			AND ID = #{id}
	</update>
	
	<update 
		id="updateGoalNullDate"
		parameterType="goalVO"
	>
	  	UPDATE W_GOAL
	  	SET 
	  		importance = #{importance},
	  		title = #{title},
	  		content = #{content},
	  		limitdate = null
	  	WHERE 
	  		isdelete = '0'  
			AND ID = #{id}
	</update>
	
	  <update 
	  	id="deleteGoal" 
	  	parameterType="java.util.Map"
	  >
	    UPDATE W_GOAL
	  	SET 
	  		isDelete = '1'
	  	WHERE 
	  		member_id = #{member_id}
			AND ID = #{goal_id}
	  </update>
	
	<select 
		id="yearlyPlanList" 
		resultMap="yearlyPlanVOResult" 
		parameterType="java.util.Map"
	>
      <![CDATA[
		SELECT 
			ID,
			title,
			content,
			importance,
			isCompleted,
			TO_CHAR(limitdate, 'YYYY-MM-DD') AS limitdate,
			TO_CHAR(startdate, 'YYYY-MM-DD') AS startdate
		FROM W_yearly_plan 
		WHERE 
			isdelete = '0' 
			AND member_id = #{member_id}
			AND ID in (
						SELECT yearly_plan_id
						FROM W_goal_yearlyplan
						WHERE 
							goal_id = #{goal_id}
					)
		ORDER BY credate DESC
      ]]>
	</select>

	  <update 
	  	id="completeGoal" 
		parameterType="java.util.Map"
	  >
	    UPDATE W_GOAL
	  	SET isCompleted = '1'
	  	WHERE 
	  		member_id = #{member_id}
			AND ID = #{goal_id}
	  </update>
	
</mapper>